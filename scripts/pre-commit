#!/bin/bash

# Pre-commit hook for Flutter/Dart projects
# Runs dart format and flutter analyze before committing

echo "Running pre-commit checks..."

# Get the flutter path (try common locations)
FLUTTER_PATH=""
if command -v flutter &> /dev/null; then
    FLUTTER_PATH="flutter"
elif [ -x "$HOME/flutter/bin/flutter" ]; then
    FLUTTER_PATH="$HOME/flutter/bin/flutter"
elif [ -x "$HOME/.fvm/default/bin/flutter" ]; then
    FLUTTER_PATH="$HOME/.fvm/default/bin/flutter"
fi

if [ -z "$FLUTTER_PATH" ]; then
    echo "Warning: Flutter not found, skipping pre-commit checks"
    exit 0
fi

DART_PATH="${FLUTTER_PATH%flutter}dart"

# Get staged Dart files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.dart$')

if [ -z "$STAGED_FILES" ]; then
    echo "No Dart files staged, skipping checks"
    exit 0
fi

# Format staged files
echo "Formatting Dart files..."
echo "$STAGED_FILES" | xargs $DART_PATH format

# Re-add formatted files
echo "$STAGED_FILES" | xargs git add

# Run analyze (warnings as errors)
echo "Running Flutter analyze..."
$FLUTTER_PATH analyze --no-fatal-infos --fatal-warnings

if [ $? -ne 0 ]; then
    echo ""
    echo "Flutter analyze found issues. Please fix them before committing."
    exit 1
fi

echo "Pre-commit checks passed!"
exit 0
